<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:400,500,700&display=swap">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <title>Chat</title>
</head>

<style>
    :root {
        --primary-color: {{ primary_color }}; /* Azul escuro ErichEdu */
    }
</style>
<body>
    <div class="chat-container">
        <header class="chat-header">
            <h1>{{ turma.nome }}</h1>
            <div class="call-options">
                <button class="call-button">ðŸ“ž</button>
            </div>
        </header>

        <div class="chat-body" id="chat-body">
            <div class="message-list">
                {% for nome, mensagem, rotulos, foto_perfil, timestamp in mensagens %}
                    <div class="message {{ 'sent' if nome == current_user.nome_completo else 'received' }}">
                        <img src="{{ foto_perfil or 'default-avatar.png' }}" alt="Foto de perfil" class="m-profile-pic">
                        <div class="message-bubble">
                            <div class="message-info">
                                <strong>{{ nome }}</strong> <span class="timestamp">{{ timestamp }}</span>
                            </div>
                            <p>{{ mensagem }}</p>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>

        <div class="chat-footer">
            <input type="text" id="message-input" placeholder="Digite sua mensagem...">
            <button id="send-button">Enviar</button>
            <button class="attach-button">ðŸ“Ž</button>
            <button class="emoji-button">ðŸ˜Š</button>
        </div>
    </div>

    <script src="https://js.pusher.com/7.0/pusher.min.js"></script>
    <script>
        // ConfiguraÃ§Ã£o do Pusher
        const pusher = new Pusher('4df4366db18a7f9ff11e', {
            cluster: 'sa1'
        });
        const channel = pusher.subscribe('turma-{{ turma.id }}');

        channel.bind('new-message', function(data) {
            const messageList = document.querySelector('.message-list');
            const newMessage = document.createElement('div');
            newMessage.className = `message ${data.user_nome === "{{ current_user.nome_completo }}" ? 'sent' : 'received'}`;
            newMessage.innerHTML = `
                <img src="${data.foto_perfil || 'default-avatar.png'}" alt="Foto de perfil" class="message-profile-pic">
                <div class="message-bubble">
                    <div class="message-info">
                        <strong>${data.user_nome}</strong> <span class="timestamp">${data.time}</span>
                    </div>
                    <p>${data.message}</p>
                </div>
            `;
            messageList.appendChild(newMessage);
            messageList.scrollTop = messageList.scrollHeight; // Rolagem automÃ¡tica
        });

        document.getElementById('send-button').addEventListener('click', function() {
            const input = document.getElementById('message-input');
            const message = input.value;
            if (message.trim() === '') return;

            const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
            const turmaId = {{ turma.id }};
            fetch('/send_message', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ turma_id: turmaId, message: message, time: time })
            }).then(response => {
                if (response.ok) {
                    input.value = '';
                }
            });
        });

        // Rolagem automÃ¡tica na inicializaÃ§Ã£o
        document.addEventListener("DOMContentLoaded", function() {
            const messageList = document.querySelector('.message-list');
            messageList.scrollTop = messageList.scrollHeight;
        });
    </script>
</body>
</html>
